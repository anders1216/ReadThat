webpackJsonp([7],{159:function(e,n,t){"use strict";Object.defineProperty(n,"__esModule",{value:!0});var o=t(1),i=t(4),r=t(2),c=t.n(r),a=t(8),s=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}();var u=function(e){function n(e){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,n);var t=function(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!==typeof n&&"function"!==typeof n?e:n}(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));l.call(t);var o=t.props.unopenedChannels,i=o.length>0;return t.state={visible:i,unopenedChannels:o},t}return function(e,n){if("function"!==typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}(n,o["Component"]),s(n,[{key:"componentDidMount",value:function(){var e=this.props.pusherKey;Object(a.a)(e,{channelId:"private-message-notifications-"+window.currentUser.id,messageCreated:this.receiveNewMessage});var n=this;document.getElementById("connect-link").onclick=function(){document.getElementById("connect-number").classList.remove("showing"),n.setState({visible:!1})}}},{key:"render",value:function(){var e=this.state,n=e.visible,t=e.unopenedChannels;if(n){var i=t.map(function(e){return Object(o.h)("a",{href:"/connect?active_channel="+e.id,style:{background:"#66e2d5",color:"black",border:"1px solid black",padding:"2px 7px",display:"inline-block",margin:"3px 6px",borderRadius:"3px"}},e.adjusted_slug)});return Object(o.h)("a",{onClick:this.handleClick,href:"/connect/"+t[0].adjusted_slug,style:{position:"fixed",zIndex:"200",top:"44px",right:0,left:0,background:"#66e2d5",borderBottom:"1px solid black",color:"black",fontWeight:"bold",textAlign:"center",fontSize:"17px",opacity:"0.94",padding:"19px 5px 14px"}},"New Message from"," ",i)}return""}}]),n}();Object.defineProperty(u,"defaultProps",{enumerable:!0,writable:!0,value:{unopenedChannels:void 0,pusherKey:void 0}});var l=function(){var e=this;Object.defineProperty(this,"propTypes",{enumerable:!0,writable:!0,value:{unopenedChannels:c.a.Object,pusherKey:c.a.Object}}),Object.defineProperty(this,"receiveNewMessage",{enumerable:!0,writable:!0,value:function(n){if(!window.location.pathname.startsWith("/connect")){var t=e.state.unopenedChannels,o={adjusted_slug:n.chat_channel_adjusted_slug};0===t.filter(function(e){return e.adjusted_slug===o.adjusted_slug}).length&&o.adjusted_slug!=="@"+window.currentUser.username&&t.push(o),e.setState({visible:t.length>0&&n.user_id!==window.currentUser.id,unopenedChannels:t});var i=document.getElementById("connect-number");i.classList.add("showing"),i.innerHTML=t.length;var r=e;0===t.length?i.classList.remove("showing"):document.getElementById("connect-link").href="/connect?active_channel="+t[0].id,setTimeout(function(){r.setState({visible:!1})},7500)}}}),Object.defineProperty(this,"handleClick",{enumerable:!0,writable:!0,value:function(){document.getElementById("connect-number").classList.remove("showing"),e.setState({visible:!1})}})};function d(){Object(o.render)(Object(o.h)(u,{unopenedChannels:[],pusherKey:document.body.dataset.pusherKey}),document.getElementById("message-notice")),window.location.pathname.startsWith("/connect")||fetch("/chat_channels?state=unopened",{credentials:"same-origin"}).then(function(e){return e.json()}).then(function(e){!function(e){var n=document.getElementById("connect-number");e.length>0?(n.classList.add("showing"),n.innerHTML=e.length,document.getElementById("connect-link").href="/connect?active_channel="+e[0].id):n.classList.remove("showing")}(e)})}HTMLDocument.prototype.ready=new Promise(function(e){return"loading"!==document.readyState?e():(document.addEventListener("DOMContentLoaded",function(){return e()}),null)}),document.ready.then(Object(i.c)().then(function(e){var n=e.currentUser,i=e.csrfToken;window.currentUser=n,window.csrfToken=i,d(),null===document.head.querySelector('meta[name="user-signed-in"][content="true"]')||n.saw_onboarding||t.e(2).then(t.bind(null,358)).then(function(e){var n=e.default,t=setInterval(function(){document.getElementById("main-head-stylesheet")&&(Object(o.render)(Object(o.h)(n,null),document.getElementById("top-bar")),clearInterval(t))},3)}).catch(function(e){console.error("Unable to load onboarding",e)})}).catch(function(e){console.error("Error getting user and CSRF Token",e)}))},3:function(e,n,t){"use strict";n.b=function(e,n,t){fetch("/chat_channels/"+e,{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.j=function(e,n,t,o){fetch("/messages",{method:"POST",headers:{Accept:"application/json","X-CSRF-Token":window.csrfToken,"Content-Type":"application/json"},body:JSON.stringify({message:{message_markdown:n,user_id:window.currentUser.id,chat_channel_id:e}}),credentials:"same-origin"}).then(function(e){return e.json()}).then(t).catch(o)},n.k=function(e,n,t){fetch("/chat_channels/"+e+"/open",{method:"POST",headers:{Accept:"application/json","X-CSRF-Token":window.csrfToken,"Content-Type":"application/json"},body:JSON.stringify({}),credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.a=function(e,n,t,o){fetch("/chat_channels/"+e+"/moderate",{method:"POST",headers:{Accept:"application/json","X-CSRF-Token":window.csrfToken,"Content-Type":"application/json"},body:JSON.stringify({chat_channel:{command:n}}),credentials:"same-origin"}).then(function(e){return e.json()}).then(t).catch(o)},n.d=function(e,n,t,i,r,c,a){var s=algoliasearch(t.algoliaId,t.algoliaKey).initIndex(t.algoliaIndex),u=o({hitsPerPage:30+i,page:i},r);s.search(e,u).then(function(t){var o=t.hits;null===n||1===t.hits.filter(function(e){return e.chat_channel_id===n}).length?c(o,e):fetch("/chat_channel_memberships/find_by_chat_channel_id?chat_channel_id="+n,{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(function(n){o.unshift(n),c(o,e)})})},n.i=function(e,n,t){fetch("/push_notification_subscriptions",{method:"POST",headers:{Accept:"application/json","X-CSRF-Token":window.csrfToken,"Content-Type":"application/json"},body:JSON.stringify({subscription:e}),credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.g=function(e,n,t){fetch("/twilio_tokens/"+e,{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.e=function(e,n,t){fetch(e,{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.f=function(e,n,t){fetch(e,{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(n).catch(t)},n.c=function(e,n){fetch("/chat_channels?state=pending",{Accept:"application/json","Content-Type":"application/json",credentials:"same-origin"}).then(function(e){return e.json()}).then(e).catch(n)},n.h=function(e,n,t,o){fetch("/chat_channel_memberships/"+e,{method:"PUT",headers:{Accept:"application/json","X-CSRF-Token":window.csrfToken,"Content-Type":"application/json"},body:JSON.stringify({chat_channel_membership:{user_action:n}}),credentials:"same-origin"}).then(function(e){return e.json()}).then(t).catch(o)};var o=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}},4:function(e,n,t){"use strict";n.c=function(){return new Promise(function(e,n){c({resolve:e,reject:n})()})},n.e=function(){var e=document.getElementById("messagelist");e.scrollTop=e.scrollHeight},n.g=function(e){var n=document.querySelector("#messagelist__sentinel");new IntersectionObserver(e,{threshold:[0,1]}).observe(n)},n.d=function(e,n){return Object.keys(e).reduce(function(t,o){var i=e[o].map(function(e){if(e.user_id===n){var t=Object.assign({type:"hidden"},e);return t.message="<message removed>",t.messageColor="lightgray",t}return e});return r({},t,function(e,n,t){n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t;return e}({},o,i))},{})},n.a=function(e){var n=new Date(e);return n=new Intl.DateTimeFormat("en-US",{month:"long",day:"numeric",hour:"numeric",minute:"numeric"}).format(n)},n.f=a,n.b=function(){if(!window.location.href.includes("ask-for-notifications"))return"dont-ask";if(!("Notification"in window))return"not-supported";var e=Notification.permission;"granted"===e&&a();return"default"===e?"waiting-permission":e};var o=t(6),i=(t.n(o),t(3)),r=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e};var c=function(e){var n=e.resolve,t=e.reject,o=e.waitTime,i=void 0===o?20:o,r=0;return function e(){if(3e3!==r){var o,c=(document,null!==(o=document.querySelector("meta[name='csrf-token']"))?o.content:void 0),a=document.body.dataset.user;if(a&&void 0!==c){var s=JSON.parse(a);n({currentUser:s,csrfToken:c})}else r+=i,setTimeout(e,i)}else t(new Error("Couldn't find user data on page."))}};function a(){navigator.serviceWorker.ready.then(function(e){e.pushManager.getSubscription().then(function(n){return n||e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:window.vapidPublicKey})}).then(function(e){Object(i.i)(e.toJSON(),null,null)})})}},8:function(e,n,t){"use strict";n.a=function(e,n){return t.e(0).then(t.bind(null,140)).then(function(t){var o=window,i=o.pusher,r=void 0===i?new Pusher(e,{authEndpoint:"/pusher/auth",auth:{headers:{"X-CSRF-Token":window.csrfToken}},cluster:"us2",encrypted:!0}):i;window.pusher=r;var c=r.subscribe(n.channelId.toString());return c.bind("message-created",n.messageCreated),c.bind("channel-cleared",n.channelCleared),c.bind("user-banned",n.redactUserMessages),c.bind("client-livecode",n.liveCoding),c.bind("client-initiatevideocall",n.videoCallInitiated),c.bind("client-endvideocall",n.videoCallEnded),c.bind("pusher:subscription_error",n.channelError),c})}}},[159]);
//# sourceMappingURL=Onboarding-c0c6681d2cd8fa6b1f23.js.map